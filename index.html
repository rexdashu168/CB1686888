<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBAS查詢工具 - 終極除錯版</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .debug-panel {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #ddd;
        }
        .debug-title {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .status-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .status-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #667eea;
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .search-section { 
            padding: 30px; 
            background: white; 
        }
        .search-box { 
            display: flex; 
            gap: 10px; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        #cbCodeInput { 
            flex: 1; 
            padding: 15px; 
            font-size: 1.2em; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
        }
        #searchBtn { 
            padding: 15px 40px; 
            font-size: 1.2em; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold;
        }
        #searchBtn:hover { background: #5568d3; }
        .result-section { 
            padding: 30px; 
        }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        thead { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        th { 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
        }
        td { 
            padding: 12px; 
            text-align: center; 
            border-bottom: 1px solid #eee; 
        }
        tbody tr:hover { 
            background: #f8f9fa; 
        }
        .term-2 { background: rgba(102, 126, 234, 0.1); }
        .term-3 { background: rgba(118, 75, 162, 0.1); }
        .note-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
        }
        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .log-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .log-item {
            padding: 3px 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>🔍 CBAS查詢工具 - 終極除錯版</h1>
            <p>詳細顯示所有載入和搜尋資訊</p>
        </div>
        
        <div class="debug-panel">
            <div class="debug-title">📊 系統載入狀態</div>
            <div id="statusBox" class="status-box">
                <div class="status-item">⏳ 正在載入...</div>
            </div>
            
            <div id="logBox" class="log-box" style="display:none;">
                <strong>詳細日誌:</strong>
                <div id="logContent"></div>
            </div>
            
            <button onclick="testLoad()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                🔄 重新載入測試
            </button>
        </div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="cbCodeInput" placeholder="請輸入CB代號 (例如: 11011)">
                <button id="searchBtn" onclick="searchCB()">查詢</button>
            </div>
        </div>
        
        <div id="resultDiv" class="result-section"></div>
    </div>

    <script>
        let excelData = null;
        let cbListData = null;
        let logs = [];
        
        function addLog(msg, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ time: timestamp, msg: msg, isError: isError });
            console.log(msg);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            const logBox = document.getElementById('logBox');
            logBox.style.display = 'block';
            
            logContent.innerHTML = logs.map(log => 
                `<div class="log-item" style="color: ${log.isError ? '#dc3545' : '#333'}">
                    [${log.time}] ${log.msg}
                </div>`
            ).join('');
            
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function updateStatus(html) {
            document.getElementById('statusBox').innerHTML = html;
        }
        
        function testLoad() {
            logs = [];
            loadExcelFile();
        }
        
        window.onload = function() {
            addLog('=== 頁面載入完成 ===');
            loadExcelFile();
        };
        
        async function loadExcelFile() {
            addLog('開始載入 cbas_list.xlsx');
            updateStatus('<div class="status-item">⏳ 正在載入 Excel 檔案...</div>');
            
            try {
                addLog('執行 fetch cbas_list.xlsx');
                const response = await fetch('cbas_list.xlsx');
                
                addLog('收到回應,狀態: ' + response.status);
                
                if (!response.ok) {
                    throw new Error('HTTP錯誤 ' + response.status);
                }
                
                addLog('開始讀取檔案內容');
                const arrayBuffer = await response.arrayBuffer();
                addLog('檔案大小: ' + arrayBuffer.byteLength + ' bytes');
                
                addLog('解析 Excel 檔案');
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                addLog('找到工作表: ' + workbook.SheetNames.join(', '));
                
                // 讀取CB清單
                if (!workbook.Sheets['全部CB代號']) {
                    throw new Error('找不到「全部CB代號」工作表');
                }
                
                addLog('讀取CB清單...');
                const cbListSheet = workbook.Sheets['全部CB代號'];
                cbListData = XLSX.utils.sheet_to_json(cbListSheet, {header: 1});
                const cbCount = cbListData.length - 1;
                addLog('✓ CB清單載入成功: ' + cbCount + ' 個CB');
                
                // 讀取月份資料
                addLog('讀取月份資料...');
                excelData = {};
                let monthCount = 0;
                const monthList = [];
                
                workbook.SheetNames.forEach(sheetName => {
                    if (/^\d{6}$/.test(sheetName)) {
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        excelData[sheetName] = data;
                        monthCount++;
                        monthList.push(sheetName);
                        addLog('  ✓ ' + sheetName + ': ' + (data.length - 1) + ' 筆');
                    }
                });
                
                monthList.sort();
                addLog('✓ 月份資料載入完成: ' + monthCount + ' 個月份');
                
                // 顯示狀態
                let statusHTML = `
                    <div class="status-item">
                        <span class="status-label">載入狀態:</span>
                        <span class="success">✓ 成功</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">CB總數:</span>
                        ${cbCount} 個
                    </div>
                    <div class="status-item">
                        <span class="status-label">月份總數:</span>
                        ${monthCount} 個
                    </div>
                    <div class="status-item">
                        <span class="status-label">月份範圍:</span>
                        ${monthList[0]} ~ ${monthList[monthList.length-1]}
                    </div>
                    <div class="status-item">
                        <span class="status-label">CB範例:</span>
                        ${cbListData.slice(1, 4).map(row => row[1] + ' (' + row[2] + ')').join(', ')}
                    </div>
                    <div class="status-item">
                        <span class="status-label">建議測試:</span>
                        <span style="color: #667eea; font-weight: bold;">${cbListData[1][1]}</span>
                    </div>
                `;
                
                updateStatus(statusHTML);
                addLog('=== 載入完成,可以開始查詢 ===');
                
            } catch (error) {
                addLog('✗ 載入失敗: ' + error.message, true);
                updateStatus(`
                    <div class="status-item">
                        <span class="status-label">載入狀態:</span>
                        <span class="error">✗ 失敗</span>
                    </div>
                    <div class="status-item error">
                        錯誤訊息: ${error.message}
                    </div>
                    <div class="status-item">
                        請檢查:<br>
                        1. cbas_list.xlsx 是否存在<br>
                        2. 檔案是否與 index.html 在同一位置<br>
                        3. 檔案名稱是否正確
                    </div>
                `);
            }
        }
        
        function searchCB() {
            const cbCode = document.getElementById('cbCodeInput').value.trim();
            
            addLog('');
            addLog('=== 開始搜尋: ' + cbCode + ' ===');
            
            if (!cbCode) {
                alert('請輸入CB代號');
                return;
            }
            
            if (!excelData || !cbListData) {
                alert('資料尚未載入完成,請稍後再試');
                addLog('✗ 搜尋失敗: 資料未載入', true);
                return;
            }
            
            // 搜尋CB清單
            let cbName = '';
            let found = false;
            
            addLog('步驟1: 在CB清單中查找 ' + cbCode);
            for (let i = 1; i < cbListData.length; i++) {
                if (String(cbListData[i][1]).trim() === String(cbCode).trim()) {
                    cbName = cbListData[i][2];
                    found = true;
                    addLog('✓ 找到: ' + cbCode + ' ' + cbName);
                    break;
                }
            }
            
            if (!found) {
                addLog('✗ 在CB清單中找不到此代號', true);
                showError('找不到CB代號: ' + cbCode);
                return;
            }
            
            // 搜尋月份資料
            addLog('步驟2: 搜尋月份資料');
            const results = [];
            const months = Object.keys(excelData).sort();
            
            months.forEach(month => {
                const data = excelData[month];
                for (let i = 1; i < data.length; i++) {
                    if (String(data[i][0]).trim() === String(cbCode).trim()) {
                        const notional = data[i][2] || 0;
                        const shares = Math.floor(notional / 100000);
                        const avg = data[i][6] || 0;
                        const premium = Math.round((avg * notional / 100000 / 10000));
                        
                        results.push({
                            yearMonth: convertYM(month),
                            shares: shares,
                            transactions: data[i][3] || 0,
                            lowest: data[i][4] || 0,
                            highest: data[i][5] || 0,
                            average: avg,
                            term: data[i][7] || 0,
                            premium: premium
                        });
                        
                        addLog('  ✓ ' + month + ': 找到資料');
                    }
                }
            });
            
            addLog('搜尋完成: 共 ' + results.length + ' 筆資料');
            
            if (results.length === 0) {
                addLog('✗ 查無交易記錄', true);
                showError('查無資料: ' + cbCode + ' ' + cbName + '<br><small>此CB在所有月份中都沒有CBAS交易記錄</small>');
                return;
            }
            
            displayResults(cbCode, cbName, results);
        }
        
        function convertYM(yyyymm) {
            const y = parseInt(yyyymm.substring(0, 4));
            const m = parseInt(yyyymm.substring(4, 6));
            return (y - 1911) + '/' + String(m).padStart(2, '0');
        }
        
        function displayResults(cbCode, cbName, results) {
            const monthMap = {};
            results.forEach(r => {
                if (!monthMap[r.yearMonth]) monthMap[r.yearMonth] = [];
                monthMap[r.yearMonth].push(r);
            });
            const hasDup = Object.values(monthMap).some(arr => arr.length > 1);
            
            let html = `
                <div class="result-header">
                    <h2>✓ 查詢成功: ${cbCode} ${cbName}</h2>
                    <p>找到 ${results.length} 筆資料 | ${Object.keys(monthMap).length} 個月份</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>年月</th><th>拆解張數</th><th>成交筆數</th>
                            <th>權利金區間</th><th>平均</th><th>期間</th><th>權利金(萬)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(r => {
                const cls = r.term == 2 ? 'term-2' : 'term-3';
                html += `
                    <tr class="${cls}">
                        <td>${r.yearMonth}</td>
                        <td>${r.shares.toLocaleString()}</td>
                        <td>${r.transactions.toLocaleString()}</td>
                        <td>${r.lowest.toFixed(2)} - ${r.highest.toFixed(2)}</td>
                        <td>${r.average.toFixed(2)}</td>
                        <td>${r.term}年</td>
                        <td>${r.premium.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            if (hasDup) {
                html += '<div class="note-section"><strong>📌 說明:</strong><br>';
                Object.keys(monthMap).forEach(m => {
                    if (monthMap[m].length > 1) {
                        html += `• ${m} 出現兩筆資料 (新拆解/續約)<br>`;
                    }
                });
                html += '• 不同契約期間用顏色區分</div>';
            }
            
            document.getElementById('resultDiv').innerHTML = html;
        }
        
        function showError(msg) {
            document.getElementById('resultDiv').innerHTML = `
                <div class="error-message">
                    <h3>✗ ${msg}</h3>
                </div>
            `;
        }
        
        document.getElementById('cbCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCB();
        });
    </script>
</body>
</html>
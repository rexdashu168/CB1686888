<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBASæŸ¥è©¢å·¥å…· - æ­·å²æœˆæ‹†è§£è³‡æ–™</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .info-banner { background: #d1ecf1; border-left: 5px solid #0c5460; color: #0c5460; padding: 15px 20px; margin: 20px 40px; border-radius: 5px; }
        .info-banner strong { margin-right: 10px; }
        .search-section { padding: 40px; background: #f8f9fa; }
        .search-box { display: flex; gap: 15px; max-width: 600px; margin: 0 auto; }
        #cbCodeInput { flex: 1; padding: 15px 20px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 10px; outline: none; transition: all 0.3s; }
        #cbCodeInput:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        #searchBtn { padding: 15px 40px; font-size: 1.2em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        #searchBtn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #667eea; }
        .loading-detail { font-size: 0.9em; color: #999; margin-top: 10px; }
        .result-section { padding: 40px; }
        .result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 10px; margin-bottom: 30px; }
        .result-header h2 { font-size: 1.8em; }
        .result-info { font-size: 0.9em; margin-top: 10px; opacity: 0.9; }
        .table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        th { padding: 15px; text-align: center; font-weight: bold; font-size: 1em; white-space: nowrap; }
        td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #eee; }
        tbody tr { transition: all 0.3s; }
        tbody tr:hover { background: #f8f9fa; transform: scale(1.01); }
        .term-2 { background: rgba(102, 126, 234, 0.1); }
        .term-3 { background: rgba(118, 75, 162, 0.1); }
        .note-section { margin-top: 30px; padding: 20px; background: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; }
        .note-section h3 { color: #856404; margin-bottom: 10px; font-size: 1.2em; }
        .note-section ul { list-style: none; padding-left: 20px; }
        .note-section li { color: #856404; margin: 5px 0; font-size: 1em; }
        .note-section li:before { content: "â€¢ "; color: #ffc107; font-weight: bold; margin-right: 5px; }
        .error-message { text-align: center; padding: 40px; color: #dc3545; font-size: 1.2em; }
        .error-details { margin-top: 20px; text-align: left; background: #f8d7da; border: 1px solid #f5c6cb; border-radius: 5px; padding: 20px; max-width: 600px; margin: 20px auto; }
        .error-details h4 { color: #721c24; margin-bottom: 10px; }
        .error-details ul { color: #721c24; padding-left: 20px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ã€CBASæŸ¥è©¢å·¥å…·ã€‘</h1>
            <p>æ­·å²æœˆæ‹†è§£è³‡æ–™èˆ‡åƒ¹æ ¼èµ°å‹¢åœ–</p>
        </div>
        <div id="infoBanner" style="display:none;" class="info-banner"></div>
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="cbCodeInput" placeholder="è«‹è¼¸å…¥CBä»£è™Ÿ (ä¾‹å¦‚: 67531)" maxlength="5">
                <button id="searchBtn" onclick="searchCB()">æŸ¥è©¢</button>
            </div>
        </div>
        <div id="loadingDiv" class="loading" style="display:none;">
            <div>è¼‰å…¥ä¸­...</div>
            <div id="loadingDetail" class="loading-detail"></div>
        </div>
        <div id="resultDiv" class="result-section" style="display:none;"></div>
    </div>
    <script>let excelData = null;
        let cbListData = null;
        let loadInfo = { cbCount: 0, monthCount: 0, months: [] };
        
        window.onload = function() { loadExcelFile(); };
        
        async function loadExcelFile() {
            console.log('=== é–‹å§‹è¼‰å…¥Excelæª”æ¡ˆ ===');
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('loadingDetail').textContent = 'æ­£åœ¨è®€å– cbas_list.xlsx...';
            
            try {
                const response = await fetch('cbas_list.xlsx');
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥cbas_list.xlsxæª”æ¡ˆ');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                console.log('å·¥ä½œè¡¨æ¸…å–®:', workbook.SheetNames);
                
                // è®€å–CBæ¸…å–®
                if (!workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ']) {
                    throw new Error('æ‰¾ä¸åˆ°ã€Œå…¨éƒ¨CBä»£è™Ÿã€å·¥ä½œè¡¨');
                }
                
                const cbListSheet = workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ'];
                cbListData = XLSX.utils.sheet_to_json(cbListSheet, {header: 1});
                loadInfo.cbCount = cbListDatlet excelData = null;
        let cbListData = null;
        let loadInfo = { cbCount: 0, monthCount: 0, months: [] };
        
        window.onload = function() { loadExcelFile(); };
        
        async function loadExcelFile() {
            console.log('=== é–‹å§‹è¼‰å…¥Excelæª”æ¡ˆ ===');
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('loadingDetail').textContent = 'æ­£åœ¨è®€å– cbas_list.xlsx...';
            
            try {
                const response = await fetch('cbas_list.xlsx');
                if (!response.ok) {
                    throw new Error('ç„¡æ³•è¼‰å…¥cbas_list.xlsxæª”æ¡ˆ');
                }
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                console.log('å·¥ä½œè¡¨æ¸…å–®:', workbook.SheetNames);
                
                // è®€å–CBæ¸…å–®
                if (!workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ']) {
                    throw new Error('æ‰¾ä¸åˆ°ã€Œå…¨éƒ¨CBä»£è™Ÿã€å·¥ä½œè¡¨');
                }
                
                const cbListSheet = workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ'];
                cbListData = XLSX.utils.sheet_to_json(cbListSheet, {header: 1});
                loadInfo.cbCount = cbListData.length - 1; // æ‰£é™¤è¡¨é ­
                console.log(`âœ… CBæ¸…å–®è¼‰å…¥æˆåŠŸ: ${loadInfo.cbCount} å€‹CB`);
                
                // è®€å–æ‰€æœ‰æœˆä»½å·¥ä½œè¡¨
                excelData = {};
                workbook.SheetNames.forEach(sheetName => {
                    if (/^\d{6}$/.test(sheetName)) {
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        excelData[sheetName] = data;
                        loadInfo.months.push(sheetName);
                        console.log(`âœ… è¼‰å…¥æœˆä»½: ${sheetName} (${data.length-1} ç­†è³‡æ–™)`);
                    }
                });
                
                loadInfo.monthCount = loadInfo.months.length;
                loadInfo.months.sort();
                
                console.log('=== è¼‰å…¥å®Œæˆ ===');
                console.log(`ç¸½å…±: ${loadInfo.cbCount} å€‹CB, ${loadInfo.monthCount} å€‹æœˆä»½`);
                console.log(`æœˆä»½ç¯„åœ: ${loadInfo.months[0]} ~ ${loadInfo.months[loadInfo.months.length-1]}`);
                
                // é¡¯ç¤ºè¼‰å…¥è³‡è¨Š
                const infoBanner = document.getElementById('infoBanner');
                infoBanner.innerHTML = `
                    <strong>âœ… è³‡æ–™è¼‰å…¥æˆåŠŸ</strong>
                    CBæ¸…å–®: ${loadInfo.cbCount} å€‹ | 
                    æœˆä»½è³‡æ–™: ${loadInfo.monthCount} å€‹æœˆ | 
                    ç¯„åœ: ${convertYearMonth(loadInfo.months[0])} ~ ${convertYearMonth(loadInfo.months[loadInfo.months.length-1])}
                `;
                infoBanner.style.display = 'block';
                document.getElementById('loadingDiv').style.display = 'none';
                
            } catch (error) {
                console.error('âŒ è¼‰å…¥å¤±æ•—:', error);
                document.getElementById('loadingDiv').innerHTML = `
                    <div style="color: #dc3545;">
                        <h3>è¼‰å…¥å¤±æ•—</h3>
                        <p>${error.message}</p>
                        <p style="font-size: 0.9em; margin-top: 10px;">è«‹ç¢ºèª cbas_list.xlsx èˆ‡ index.html åœ¨åŒä¸€è³‡æ–™å¤¾</p>
                    </div>
                `;
            }
        }
        
        function convertYearMonth(sheetName) {
            const year = parseInt(sheetName.substring(0, 4));
            const month = parseInt(sheetName.substring(4, 6));
            const twYear = year - 1911;
            return `${twYear}/${month.toString().padStart(2, '0')}`;
        }
        
        function searchCB() {
            const cbCode = document.getElementById('cbCodeInput').value.trim();
            if (!cbCode) { alert('è«‹è¼¸å…¥CBä»£è™Ÿ'); return; }
            if (!excelData) { alert('Excelè³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ,è«‹ç¨å¾Œå†è©¦'); return; }
            
            console.log(`\n=== é–‹å§‹æœå°‹CB: ${cbCode} ===`);
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('loadingDetail').textContent = `æ­£åœ¨æœå°‹ ${cbCode}...`;
            document.getElementById('resultDiv').style.display = 'none';
            
            setTimeout(() => { processSearch(cbCode); }, 300);
        }
        
        function processSearch(cbCode) {
            try {
                // å¾CBæ¸…å–®æ‰¾åˆ°CBåç¨±
                let cbName = '';
                let cbFound = false;
                console.log('æœå°‹CBæ¸…å–®...');
                for (let i = 1; i < cbListData.length; i++) {
                    if (cbListData[i][1] == cbCode) {
                        cbName = cbListData[i][2];
                        cbFound = true;
                        console.log(`âœ… æ‰¾åˆ°CB: ${cbCode} ${cbName}`);
                        break;
                    }
                }
                
                if (!cbFound) {
                    console.log(`âŒ åœ¨CBæ¸…å–®ä¸­æ‰¾ä¸åˆ°: ${cbCode}`);
                    showError('æ‰¾ä¸åˆ°æ­¤CBä»£è™Ÿ', cbCode);
                    return;
                }
                
                // æ”¶é›†æ‰€æœ‰æœˆä»½çš„è³‡æ–™
                const results = [];
                const monthSheets = Object.keys(excelData).sort();
                console.log(`é–‹å§‹æœå°‹ ${monthSheets.length} å€‹æœˆä»½...`);
                
                monthSheets.forEach(sheetName => {
                    const sheetData = excelData[sheetName];
                    const yearMonth = convertYearMonth(sheetName);
                    let foundInMonth = 0;
                    
                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (row[0] == cbCode) {
                            foundInMonth++;
                            const notionalAmount = row[2] || 0;
                            const shares = Math.floor(notionalAmount / 100000);
                            const average = row[6] || 0;
                            const premiumAmount = Math.round((average * notionalAmount / 100000 / 10000));
                            
                            results.push({
                                yearMonth: yearMonth, shares: shares, transactions: row[3] || 0,
                                lowest: row[4] || 0, highest: row[5] || 0, average: average,
                                term: row[7] || 0, premium: premiumAmount
                            });
                        }
                    }
                    
                    if (foundInMonth > 0) {
                        console.log(`  ${sheetName}: æ‰¾åˆ° ${foundInMonth} ç­†`);
                    }
                });
                
                console.log(`=== æœå°‹å®Œæˆ: å…±æ‰¾åˆ° ${results.length} ç­†è³‡æ–™ ===`);
                
                if (results.length === 0) {
                    showError('æŸ¥ç„¡æ­¤CBçš„æ­·å²è³‡æ–™', cbCode);
                    return;
                }
                
                displayResults(cbCode, cbName, results);
                
            } catch (error) {
                console.error('âŒ æœå°‹éŒ¯èª¤:', error);
                showError('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message, cbCode);
            }
        }
        
        function displayResults(cbCode, cbName, results) {
            const resultDiv = document.getElementById('resultDiv');
            const monthMap = {};
            results.forEach(r => {
                if (!monthMap[r.yearMonth]) monthMap[r.yearMonth] = [];
                monthMap[r.yearMonth].push(r);
            });
            const hasDuplicateMonth = Object.values(monthMap).some(arr => arr.length > 1);
            
            let html = `
                <div class="result-header">
                    <h2>ã€æŸ¥è©¢çµæœ: ${cbCode} ${cbName}ã€‘</h2>
                    <div class="result-info">
                        æ‰¾åˆ° ${results.length} ç­†è³‡æ–™ | 
                        ${Object.keys(monthMap).length} å€‹æœˆä»½ | 
                        ${results[0].yearMonth} ~ ${results[results.length-1].yearMonth}
                    </div>
                </div>
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>å¹´æœˆ</th><th>æ‹†è§£å¼µæ•¸</th><th>æˆäº¤ç­†æ•¸</th>
                                <th>æ¬Šåˆ©é‡‘å€é–“(å…ƒ)</th><th>å¹³å‡(å…ƒ)</th><th>æœŸé–“</th><th>æ¬Šåˆ©é‡‘(è¬)</th>
                            </tr>
                        </thead>
                        <tbody>
            `;
            
            results.forEach(row => {
                const termClass = row.term == 2 ? 'term-2' : 'term-3';
                html += `
                    <tr class="${termClass}">
                        <td>${row.yearMonth}</td>
                        <td>${row.shares.toLocaleString()}</td>
                        <td>${row.transactions.toLocaleString()}</td>
                        <td>${row.lowest.toFixed(2)} - ${row.highest.toFixed(2)}</td>
                        <td>${row.average.toFixed(2)}</td>
                        <td>${row.term}å¹´</td>
                        <td>${row.premium.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += `</tbody></table></div>`;
            
            if (hasDuplicateMonth) {
                html += `<div class="note-section"><h3>ğŸ“Œ èªªæ˜:</h3><ul>`;
                Object.keys(monthMap).forEach(month => {
                    if (monthMap[month].length > 1) {
                        html += `<li>${month} å‡ºç¾å…©ç­†è³‡æ–™,åˆ†åˆ¥ç‚ºæ–°æ‹†è§£å¥‘ç´„èˆ‡çºŒç´„å¥‘ç´„</li>`;
                    }
                });
                html += `<li>ä¸åŒå¥‘ç´„æœŸé–“ä»¥é¡è‰²å€åˆ† (æ·¡è—è‰²=2å¹´æœŸï¼Œæ·¡ç´«è‰²=3å¹´æœŸ)</li></ul></div>`;
            }
            
            resultDiv.innerHTML = html;
            document.getElementById('loadingDiv').style.display = 'none';
            resultDiv.style.display = 'block';
        }
        
        function showError(message, cbCode) {
            const resultDiv = document.getElementById('resultDiv');
            resultDiv.innerHTML = `
                <div class="error-message">
                    <h3>âŒ ${message}</h3>
                    <div class="error-details">
                        <h4>å¯èƒ½åŸå› :</h4>
                        <ul>
                            <li>CBä»£è™Ÿè¼¸å…¥éŒ¯èª¤</li>
                            <li>æ­¤CBåœ¨è³‡æ–™æœŸé–“å…§æ²’æœ‰CBASäº¤æ˜“è¨˜éŒ„</li>
                            <li>æ­¤CBå°šæœªç™¼è¡Œæˆ–å·²åˆ°æœŸ</li>
                        </ul>
                        <h4 style="margin-top: 15px;">é™¤éŒ¯è³‡è¨Š:</h4>
                        <ul>
                            <li>æœå°‹ä»£è™Ÿ: ${cbCode || '(ç©ºç™½)'}</li>
                            <li>å¯ç”¨æœˆä»½: ${loadInfo.monthCount} å€‹</li>
                            <li>æŒ‰ F12 é–‹å•Ÿæ§åˆ¶å°æŸ¥çœ‹è©³ç´°è³‡è¨Š</li>
                        </ul>
                    </div>
                </div>
            `;
            document.getElementById('loadingDiv').style.display = 'none';
            resultDiv.style.display = 'block';
        }
        
        document.getElementById('cbCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCB();
        });
    </script>
</body>
</html>
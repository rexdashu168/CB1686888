<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBASæŸ¥è©¢å·¥å…· - çµ‚æ¥µé™¤éŒ¯ç‰ˆ</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 30px; 
            text-align: center; 
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 2em; margin-bottom: 5px; }
        .debug-panel {
            background: #f8f9fa;
            padding: 20px;
            border-bottom: 2px solid #ddd;
        }
        .debug-title {
            font-size: 1.3em;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 15px;
        }
        .status-box {
            background: white;
            border: 2px solid #667eea;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
        }
        .status-item {
            padding: 8px 0;
            border-bottom: 1px solid #eee;
            font-size: 0.95em;
        }
        .status-item:last-child {
            border-bottom: none;
        }
        .status-label {
            color: #667eea;
            font-weight: bold;
            display: inline-block;
            width: 120px;
        }
        .success { color: #28a745; font-weight: bold; }
        .error { color: #dc3545; font-weight: bold; }
        .search-section { 
            padding: 30px; 
            background: white; 
        }
        .search-box { 
            display: flex; 
            gap: 10px; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        #cbCodeInput { 
            flex: 1; 
            padding: 15px; 
            font-size: 1.2em; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
        }
        #searchBtn { 
            padding: 15px 40px; 
            font-size: 1.2em; 
            background: #667eea; 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold;
        }
        #searchBtn:hover { background: #5568d3; }
        .result-section { 
            padding: 30px; 
        }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            margin-top: 20px; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        thead { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        th { 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
        }
        td { 
            padding: 12px; 
            text-align: center; 
            border-bottom: 1px solid #eee; 
        }
        tbody tr:hover { 
            background: #f8f9fa; 
        }
        .term-2 { background: rgba(102, 126, 234, 0.1); }
        .term-3 { background: rgba(118, 75, 162, 0.1); }
        .note-section {
            margin-top: 20px;
            padding: 15px;
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            border-radius: 5px;
        }
        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        .log-box {
            background: #f8f9fa;
            border: 1px solid #ddd;
            padding: 15px;
            border-radius: 5px;
            margin: 10px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
        }
        .log-item {
            padding: 3px 0;
            color: #333;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ” CBASæŸ¥è©¢å·¥å…· - çµ‚æ¥µé™¤éŒ¯ç‰ˆ</h1>
            <p>è©³ç´°é¡¯ç¤ºæ‰€æœ‰è¼‰å…¥å’Œæœå°‹è³‡è¨Š</p>
        </div>
        
        <div class="debug-panel">
            <div class="debug-title">ğŸ“Š ç³»çµ±è¼‰å…¥ç‹€æ…‹</div>
            <div id="statusBox" class="status-box">
                <div class="status-item">â³ æ­£åœ¨è¼‰å…¥...</div>
            </div>
            
            <div id="logBox" class="log-box" style="display:none;">
                <strong>è©³ç´°æ—¥èªŒ:</strong>
                <div id="logContent"></div>
            </div>
            
            <button onclick="testLoad()" style="margin-top: 10px; padding: 10px 20px; background: #667eea; color: white; border: none; border-radius: 5px; cursor: pointer;">
                ğŸ”„ é‡æ–°è¼‰å…¥æ¸¬è©¦
            </button>
        </div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="cbCodeInput" placeholder="è«‹è¼¸å…¥CBä»£è™Ÿ (ä¾‹å¦‚: 11011)">
                <button id="searchBtn" onclick="searchCB()">æŸ¥è©¢</button>
            </div>
        </div>
        
        <div id="resultDiv" class="result-section"></div>
    </div>

    <script>
        let excelData = null;
        let cbListData = null;
        let logs = [];
        
        function addLog(msg, isError = false) {
            const timestamp = new Date().toLocaleTimeString();
            logs.push({ time: timestamp, msg: msg, isError: isError });
            console.log(msg);
            updateLogDisplay();
        }
        
        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            const logBox = document.getElementById('logBox');
            logBox.style.display = 'block';
            
            logContent.innerHTML = logs.map(log => 
                `<div class="log-item" style="color: ${log.isError ? '#dc3545' : '#333'}">
                    [${log.time}] ${log.msg}
                </div>`
            ).join('');
            
            logContent.scrollTop = logContent.scrollHeight;
        }
        
        function updateStatus(html) {
            document.getElementById('statusBox').innerHTML = html;
        }
        
        function testLoad() {
            logs = [];
            loadExcelFile();
        }
        
        window.onload = function() {
            addLog('=== é é¢è¼‰å…¥å®Œæˆ ===');
            loadExcelFile();
        };
        
        async function loadExcelFile() {
            addLog('é–‹å§‹è¼‰å…¥ cbas_list.xlsx');
            updateStatus('<div class="status-item">â³ æ­£åœ¨è¼‰å…¥ Excel æª”æ¡ˆ...</div>');
            
            try {
                addLog('åŸ·è¡Œ fetch cbas_list.xlsx');
                const response = await fetch('cbas_list.xlsx');
                
                addLog('æ”¶åˆ°å›æ‡‰,ç‹€æ…‹: ' + response.status);
                
                if (!response.ok) {
                    throw new Error('HTTPéŒ¯èª¤ ' + response.status);
                }
                
                addLog('é–‹å§‹è®€å–æª”æ¡ˆå…§å®¹');
                const arrayBuffer = await response.arrayBuffer();
                addLog('æª”æ¡ˆå¤§å°: ' + arrayBuffer.byteLength + ' bytes');
                
                addLog('è§£æ Excel æª”æ¡ˆ');
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                addLog('æ‰¾åˆ°å·¥ä½œè¡¨: ' + workbook.SheetNames.join(', '));
                
                // è®€å–CBæ¸…å–®
                if (!workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ']) {
                    throw new Error('æ‰¾ä¸åˆ°ã€Œå…¨éƒ¨CBä»£è™Ÿã€å·¥ä½œè¡¨');
                }
                
                addLog('è®€å–CBæ¸…å–®...');
                const cbListSheet = workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ'];
                cbListData = XLSX.utils.sheet_to_json(cbListSheet, {header: 1});
                const cbCount = cbListData.length - 1;
                addLog('âœ“ CBæ¸…å–®è¼‰å…¥æˆåŠŸ: ' + cbCount + ' å€‹CB');
                
                // è®€å–æœˆä»½è³‡æ–™
                addLog('è®€å–æœˆä»½è³‡æ–™...');
                excelData = {};
                let monthCount = 0;
                const monthList = [];
                
                workbook.SheetNames.forEach(sheetName => {
                    if (/^\d{6}$/.test(sheetName)) {
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        excelData[sheetName] = data;
                        monthCount++;
                        monthList.push(sheetName);
                        addLog('  âœ“ ' + sheetName + ': ' + (data.length - 1) + ' ç­†');
                    }
                });
                
                monthList.sort();
                addLog('âœ“ æœˆä»½è³‡æ–™è¼‰å…¥å®Œæˆ: ' + monthCount + ' å€‹æœˆä»½');
                
                // é¡¯ç¤ºç‹€æ…‹
                let statusHTML = `
                    <div class="status-item">
                        <span class="status-label">è¼‰å…¥ç‹€æ…‹:</span>
                        <span class="success">âœ“ æˆåŠŸ</span>
                    </div>
                    <div class="status-item">
                        <span class="status-label">CBç¸½æ•¸:</span>
                        ${cbCount} å€‹
                    </div>
                    <div class="status-item">
                        <span class="status-label">æœˆä»½ç¸½æ•¸:</span>
                        ${monthCount} å€‹
                    </div>
                    <div class="status-item">
                        <span class="status-label">æœˆä»½ç¯„åœ:</span>
                        ${monthList[0]} ~ ${monthList[monthList.length-1]}
                    </div>
                    <div class="status-item">
                        <span class="status-label">CBç¯„ä¾‹:</span>
                        ${cbListData.slice(1, 4).map(row => row[1] + ' (' + row[2] + ')').join(', ')}
                    </div>
                    <div class="status-item">
                        <span class="status-label">å»ºè­°æ¸¬è©¦:</span>
                        <span style="color: #667eea; font-weight: bold;">${cbListData[1][1]}</span>
                    </div>
                `;
                
                updateStatus(statusHTML);
                addLog('=== è¼‰å…¥å®Œæˆ,å¯ä»¥é–‹å§‹æŸ¥è©¢ ===');
                
            } catch (error) {
                addLog('âœ— è¼‰å…¥å¤±æ•—: ' + error.message, true);
                updateStatus(`
                    <div class="status-item">
                        <span class="status-label">è¼‰å…¥ç‹€æ…‹:</span>
                        <span class="error">âœ— å¤±æ•—</span>
                    </div>
                    <div class="status-item error">
                        éŒ¯èª¤è¨Šæ¯: ${error.message}
                    </div>
                    <div class="status-item">
                        è«‹æª¢æŸ¥:<br>
                        1. cbas_list.xlsx æ˜¯å¦å­˜åœ¨<br>
                        2. æª”æ¡ˆæ˜¯å¦èˆ‡ index.html åœ¨åŒä¸€ä½ç½®<br>
                        3. æª”æ¡ˆåç¨±æ˜¯å¦æ­£ç¢º
                    </div>
                `);
            }
        }
        
        function searchCB() {
            const cbCode = document.getElementById('cbCodeInput').value.trim();
            
            addLog('');
            addLog('=== é–‹å§‹æœå°‹: ' + cbCode + ' ===');
            
            if (!cbCode) {
                alert('è«‹è¼¸å…¥CBä»£è™Ÿ');
                return;
            }
            
            if (!excelData || !cbListData) {
                alert('è³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ,è«‹ç¨å¾Œå†è©¦');
                addLog('âœ— æœå°‹å¤±æ•—: è³‡æ–™æœªè¼‰å…¥', true);
                return;
            }
            
            // æœå°‹CBæ¸…å–®
            let cbName = '';
            let found = false;
            
            addLog('æ­¥é©Ÿ1: åœ¨CBæ¸…å–®ä¸­æŸ¥æ‰¾ ' + cbCode);
            for (let i = 1; i < cbListData.length; i++) {
                if (String(cbListData[i][1]).trim() === String(cbCode).trim()) {
                    cbName = cbListData[i][2];
                    found = true;
                    addLog('âœ“ æ‰¾åˆ°: ' + cbCode + ' ' + cbName);
                    break;
                }
            }
            
            if (!found) {
                addLog('âœ— åœ¨CBæ¸…å–®ä¸­æ‰¾ä¸åˆ°æ­¤ä»£è™Ÿ', true);
                showError('æ‰¾ä¸åˆ°CBä»£è™Ÿ: ' + cbCode);
                return;
            }
            
            // æœå°‹æœˆä»½è³‡æ–™
            addLog('æ­¥é©Ÿ2: æœå°‹æœˆä»½è³‡æ–™');
            const results = [];
            const months = Object.keys(excelData).sort();
            
            months.forEach(month => {
                const data = excelData[month];
                for (let i = 1; i < data.length; i++) {
                    if (String(data[i][0]).trim() === String(cbCode).trim()) {
                        const notional = data[i][2] || 0;
                        const shares = Math.floor(notional / 100000);
                        const avg = data[i][6] || 0;
                        const premium = Math.round((avg * notional / 100000 / 10000));
                        
                        results.push({
                            yearMonth: convertYM(month),
                            shares: shares,
                            transactions: data[i][3] || 0,
                            lowest: data[i][4] || 0,
                            highest: data[i][5] || 0,
                            average: avg,
                            term: data[i][7] || 0,
                            premium: premium
                        });
                        
                        addLog('  âœ“ ' + month + ': æ‰¾åˆ°è³‡æ–™');
                    }
                }
            });
            
            addLog('æœå°‹å®Œæˆ: å…± ' + results.length + ' ç­†è³‡æ–™');
            
            if (results.length === 0) {
                addLog('âœ— æŸ¥ç„¡äº¤æ˜“è¨˜éŒ„', true);
                showError('æŸ¥ç„¡è³‡æ–™: ' + cbCode + ' ' + cbName + '<br><small>æ­¤CBåœ¨æ‰€æœ‰æœˆä»½ä¸­éƒ½æ²’æœ‰CBASäº¤æ˜“è¨˜éŒ„</small>');
                return;
            }
            
            displayResults(cbCode, cbName, results);
        }
        
        function convertYM(yyyymm) {
            const y = parseInt(yyyymm.substring(0, 4));
            const m = parseInt(yyyymm.substring(4, 6));
            return (y - 1911) + '/' + String(m).padStart(2, '0');
        }
        
        function displayResults(cbCode, cbName, results) {
            const monthMap = {};
            results.forEach(r => {
                if (!monthMap[r.yearMonth]) monthMap[r.yearMonth] = [];
                monthMap[r.yearMonth].push(r);
            });
            const hasDup = Object.values(monthMap).some(arr => arr.length > 1);
            
            let html = `
                <div class="result-header">
                    <h2>âœ“ æŸ¥è©¢æˆåŠŸ: ${cbCode} ${cbName}</h2>
                    <p>æ‰¾åˆ° ${results.length} ç­†è³‡æ–™ | ${Object.keys(monthMap).length} å€‹æœˆä»½</p>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>å¹´æœˆ</th><th>æ‹†è§£å¼µæ•¸</th><th>æˆäº¤ç­†æ•¸</th>
                            <th>æ¬Šåˆ©é‡‘å€é–“</th><th>å¹³å‡</th><th>æœŸé–“</th><th>æ¬Šåˆ©é‡‘(è¬)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(r => {
                const cls = r.term == 2 ? 'term-2' : 'term-3';
                html += `
                    <tr class="${cls}">
                        <td>${r.yearMonth}</td>
                        <td>${r.shares.toLocaleString()}</td>
                        <td>${r.transactions.toLocaleString()}</td>
                        <td>${r.lowest.toFixed(2)} - ${r.highest.toFixed(2)}</td>
                        <td>${r.average.toFixed(2)}</td>
                        <td>${r.term}å¹´</td>
                        <td>${r.premium.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            if (hasDup) {
                html += '<div class="note-section"><strong>ğŸ“Œ èªªæ˜:</strong><br>';
                Object.keys(monthMap).forEach(m => {
                    if (monthMap[m].length > 1) {
                        html += `â€¢ ${m} å‡ºç¾å…©ç­†è³‡æ–™ (æ–°æ‹†è§£/çºŒç´„)<br>`;
                    }
                });
                html += 'â€¢ ä¸åŒå¥‘ç´„æœŸé–“ç”¨é¡è‰²å€åˆ†</div>';
            }
            
            document.getElementById('resultDiv').innerHTML = html;
        }
        
        function showError(msg) {
            document.getElementById('resultDiv').innerHTML = `
                <div class="error-message">
                    <h3>âœ— ${msg}</h3>
                </div>
            `;
        }
        
        document.getElementById('cbCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCB();
        });
    </script>
</body>
</html>
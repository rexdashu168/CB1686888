<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBASæŸ¥è©¢å·¥å…· - æ­·å²æœˆæ‹†è§£è³‡æ–™</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Microsoft JhengHei', 'PingFang TC', Arial, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1400px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 40px; text-align: center; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .search-section { padding: 40px; background: #f8f9fa; }
        .search-box { display: flex; gap: 15px; max-width: 600px; margin: 0 auto; }
        #cbCodeInput { flex: 1; padding: 15px 20px; font-size: 1.2em; border: 2px solid #ddd; border-radius: 10px; outline: none; transition: all 0.3s; }
        #cbCodeInput:focus { border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        #searchBtn { padding: 15px 40px; font-size: 1.2em; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 10px; cursor: pointer; transition: all 0.3s; font-weight: bold; }
        #searchBtn:hover { transform: translateY(-2px); box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); }
        .loading { text-align: center; padding: 40px; font-size: 1.2em; color: #667eea; }
        .result-section { padding: 40px; }
        .result-header { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 20px 30px; border-radius: 10px; margin-bottom: 30px; }
        .result-header h2 { font-size: 1.8em; }
        .table-container { overflow-x: auto; border-radius: 10px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
        table { width: 100%; border-collapse: collapse; background: white; }
        thead { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
        th { padding: 15px; text-align: center; font-weight: bold; font-size: 1em; white-space: nowrap; }
        td { padding: 12px 15px; text-align: center; border-bottom: 1px solid #eee; }
        tbody tr { transition: all 0.3s; }
        tbody tr:hover { background: #f8f9fa; transform: scale(1.01); }
        .term-2 { background: rgba(102, 126, 234, 0.1); }
        .term-3 { background: rgba(118, 75, 162, 0.1); }
        .note-section { margin-top: 30px; padding: 20px; background: #fff3cd; border-left: 5px solid #ffc107; border-radius: 5px; }
        .note-section h3 { color: #856404; margin-bottom: 10px; font-size: 1.2em; }
        .note-section ul { list-style: none; padding-left: 20px; }
        .note-section li { color: #856404; margin: 5px 0; font-size: 1em; }
        .note-section li:before { content: "â€¢ "; color: #ffc107; font-weight: bold; margin-right: 5px; }
        .error-message { text-align: center; padding: 40px; color: #dc3545; font-size: 1.2em; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ã€CBASæŸ¥è©¢å·¥å…·ã€‘</h1>
            <p>æ­·å²æœˆæ‹†è§£è³‡æ–™èˆ‡åƒ¹æ ¼èµ°å‹¢åœ–</p>
        </div>
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="cbCodeInput" placeholder="è«‹è¼¸å…¥CBä»£è™Ÿ (ä¾‹å¦‚: 67531)" maxlength="5">
                <button id="searchBtn" onclick="searchCB()">æŸ¥è©¢</button>
            </div>
        </div>
        <div id="loadingDiv" class="loading" style="display:none;">è¼‰å…¥ä¸­...</div>
        <div id="resultDiv" class="result-section" style="display:none;"></div>
    </div>
    <script>let excelData = null;
        let cbListData = null;
        window.onload = function() { loadExcelFile(); };
        async function loadExcelFile() {
            try {
                const response = await fetch('cbas_list.xlsx');
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                const cbListSheet = workbook.Sheets['å…¨éƒ¨CBä»£è™Ÿ'];
                cbListData = XLSX.utils.sheet_to_json(cbListSheet, {header: 1});
                excelData = {};
                workbook.SheetNames.forEach(sheetName => {
                    if (/^\d{6}$/.test(sheetName)) {
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        excelData[sheetName] = data;
                    }
                });
                console.log('Excelæª”æ¡ˆè¼‰å…¥æˆåŠŸ');
            } catch (error) {
                console.error('è¼‰å…¥Excelå¤±æ•—:', error);
                alert('ç„¡æ³•è¼‰å…¥Excelæª”æ¡ˆ,è«‹ç¢ºèªcbas_list.xlsxå­˜åœ¨æ–¼åŒä¸€è³‡æ–™å¤¾');
            }
        }
        function convertYearMonth(sheetName) {
            const year = parseInt(sheetName.substring(0, 4));
            const month = parseInt(sheetName.substring(4, 6));
            const twYear = year - 1911;
            return `${twYear}/${month.toString().padStart(2, '0')}`;
        }
        function searchCB() {
            const cbCode = document.getElementById('cbCodeInput').value.trim();
            if (!cbCode) { alert('è«‹è¼¸å…¥CBä»£è™Ÿ'); return; }
            if (!excelData) { alert('Excelè³‡æ–™å°šæœªè¼‰å…¥å®Œæˆ,è«‹ç¨å¾Œå†è©¦'); return; }
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultDiv').style.display = 'none';
            setTimeout(() => { processSearch(cbCode); }, 500);
        }
        function processSearch(cbCode) {
            try {
                let cbName = '';
                for (let i = 1; i < cbListData.length; i++) {
                    if (cbListData[i][1] == cbCode) { cbName = cbListData[i][2]; break; }
                }
                if (!cbName) { showError('æ‰¾ä¸åˆ°æ­¤CBä»£è™Ÿ'); return; }
                const results = [];
                const monthSheets = Object.keys(excelData).sort();
                monthSheets.forEach(sheetName => {
                    const sheetData = excelData[sheetName];
                    const yearMonth = convertYearMonth(sheetName);
                    for (let i = 1; i < sheetData.length; i++) {
                        const row = sheetData[i];
                        if (row[0] == cbCode) {
                            const notionalAmount = row[2] || 0;
                            const shares = Math.floor(notionalAmount / 100000);
                            const average = row[6] || 0;
                            const premiumAmount = Math.round((average * notionalAmount / 100000 / 10000));
                            results.push({
                                yearMonth: yearMonth, shares: shares, transactions: row[3] || 0,
                                lowest: row[4] || 0, highest: row[5] || 0, average: average,
                                term: row[7] || 0, premium: premiumAmount
                            });
                        }
                    }
                });
                if (results.length === 0) { showError('æŸ¥ç„¡æ­¤CBçš„æ­·å²è³‡æ–™'); return; }
                displayResults(cbCode, cbName, results);
            } catch (error) {
                console.error('æœå°‹éŒ¯èª¤:', error);
                showError('æœå°‹æ™‚ç™¼ç”ŸéŒ¯èª¤: ' + error.message);
            }
        }function displayResults(cbCode, cbName, results) {
            const resultDiv = document.getElementById('resultDiv');
            const monthMap = {};
            results.forEach(r => {
                if (!monthMap[r.yearMonth]) monthMap[r.yearMonth] = [];
                monthMap[r.yearMonth].push(r);
            });
            const hasDuplicateMonth = Object.values(monthMap).some(arr => arr.length > 1);
            let html = `<div class="result-header"><h2>ã€æŸ¥è©¢çµæœ: ${cbCode} ${cbName}ã€‘</h2></div><div class="table-container"><table><thead><tr><th>å¹´æœˆ</th><th>æ‹†è§£å¼µæ•¸</th><th>æˆäº¤ç­†æ•¸</th><th>æ¬Šåˆ©é‡‘å€é–“(å…ƒ)</th><th>å¹³å‡(å…ƒ)</th><th>æœŸé–“</th><th>æ¬Šåˆ©é‡‘(è¬)</th></tr></thead><tbody>`;
            results.forEach(row => {
                const termClass = row.term == 2 ? 'term-2' : 'term-3';
                html += `<tr class="${termClass}"><td>${row.yearMonth}</td><td>${row.shares.toLocaleString()}</td><td>${row.transactions.toLocaleString()}</td><td>${row.lowest.toFixed(2)} - ${row.highest.toFixed(2)}</td><td>${row.average.toFixed(2)}</td><td>${row.term}å¹´</td><td>${row.premium.toLocaleString()}</td></tr>`;
            });
            html += `</tbody></table></div>`;
            if (hasDuplicateMonth) {
                html += `<div class="note-section"><h3>ğŸ“Œ èªªæ˜:</h3><ul>`;
                Object.keys(monthMap).forEach(month => {
                    if (monthMap[month].length > 1) html += `<li>${month} å‡ºç¾å…©ç­†è³‡æ–™,åˆ†åˆ¥ç‚ºæ–°æ‹†è§£å¥‘ç´„èˆ‡çºŒç´„å¥‘ç´„</li>`;
                });
                html += `<li>ä¸åŒå¥‘ç´„æœŸé–“ä»¥é¡è‰²å€åˆ† (æ·¡è—è‰²=2å¹´æœŸï¼Œæ·¡ç´«è‰²=3å¹´æœŸ)</li></ul></div>`;
            }
            resultDiv.innerHTML = html;
            document.getElementById('loadingDiv').style.display = 'none';
            resultDiv.style.display = 'block';
        }
        function showError(message) {
            const resultDiv = document.getElementById('resultDiv');
            resultDiv.innerHTML = `<div class="error-message"><h3>âŒ ${message}</h3></div>`;
            document.getElementById('loadingDiv').style.display = 'none';
            resultDiv.style.display = 'block';
        }
        document.getElementById('cbCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCB();
        });
    </script>
</body>
</html>
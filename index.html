<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CBAS查詢工具</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: 'Microsoft JhengHei', Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            min-height: 100vh; 
            padding: 20px; 
        }
        .container { 
            max-width: 1400px; 
            margin: 0 auto; 
            background: white; 
            border-radius: 20px; 
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); 
        }
        .header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            padding: 40px; 
            text-align: center; 
            border-radius: 20px 20px 0 0;
        }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; }
        .info-banner {
            background: #d1ecf1;
            border-left: 5px solid #0c5460;
            color: #0c5460;
            padding: 15px 20px;
            margin: 20px 40px;
            border-radius: 5px;
        }
        .search-section { 
            padding: 40px; 
            background: #f8f9fa; 
        }
        .search-box { 
            display: flex; 
            gap: 15px; 
            max-width: 600px; 
            margin: 0 auto; 
        }
        #cbCodeInput { 
            flex: 1; 
            padding: 15px 20px; 
            font-size: 1.2em; 
            border: 2px solid #ddd; 
            border-radius: 10px; 
        }
        #searchBtn { 
            padding: 15px 40px; 
            font-size: 1.2em; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-weight: bold;
        }
        #searchBtn:hover { 
            transform: translateY(-2px); 
            box-shadow: 0 10px 20px rgba(102, 126, 234, 0.3); 
        }
        .result-section { padding: 40px; }
        .result-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            margin-bottom: 30px;
        }
        .result-header h2 { font-size: 1.8em; }
        .result-info { font-size: 0.9em; margin-top: 10px; opacity: 0.9; }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            border-radius: 10px;
            overflow: hidden;
        }
        thead { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
            color: white; 
        }
        th { 
            padding: 15px; 
            text-align: center; 
            font-weight: bold; 
        }
        td { 
            padding: 12px 15px; 
            text-align: center; 
            border-bottom: 1px solid #eee; 
        }
        tbody tr:hover { 
            background: #f8f9fa; 
            transform: scale(1.01);
            transition: all 0.3s;
        }
        .term-2 { background: rgba(102, 126, 234, 0.1); }
        .term-3 { background: rgba(118, 75, 162, 0.1); }
        .note-section {
            margin-top: 30px;
            padding: 20px;
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            border-radius: 5px;
        }
        .note-section h3 { color: #856404; margin-bottom: 10px; }
        .note-section ul { list-style: none; padding-left: 20px; }
        .note-section li { color: #856404; margin: 5px 0; }
        .note-section li:before { 
            content: "• "; 
            color: #ffc107; 
            font-weight: bold; 
            margin-right: 5px; 
        }
        .error-message {
            background: #f8d7da;
            border: 2px solid #dc3545;
            color: #721c24;
            padding: 30px;
            border-radius: 10px;
            margin: 20px 0;
            text-align: center;
        }
        .loading {
            text-align: center;
            padding: 40px;
            font-size: 1.2em;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>【CBAS查詢工具】</h1>
            <p>歷史月拆解資料與價格走勢圖</p>
        </div>
        
        <div id="infoBanner" style="display:none;" class="info-banner"></div>
        
        <div class="search-section">
            <div class="search-box">
                <input type="text" id="cbCodeInput" placeholder="請輸入CB代號 (例如: 11011)" maxlength="5">
                <button id="searchBtn" onclick="searchCB()">查詢</button>
            </div>
        </div>
        
        <div id="loadingDiv" class="loading" style="display:none;">載入中...</div>
        <div id="resultDiv" class="result-section"></div>
    </div>

    <script>
        let excelData = null;
        let cbListData = null;
        let loadInfo = { cbCount: 0, monthCount: 0, months: [] };
        
        window.onload = function() {
            loadExcelFile();
        };
        
        async function loadExcelFile() {
            console.log('=== 開始載入Excel ===');
            document.getElementById('loadingDiv').style.display = 'block';
            
            try {
                const response = await fetch('cbas_list.xlsx');
                if (!response.ok) throw new Error('無法載入檔案');
                
                const arrayBuffer = await response.arrayBuffer();
                const workbook = XLSX.read(arrayBuffer, {type: 'array'});
                console.log('工作表:', workbook.SheetNames);
                
                // 讀取CB清單
                const cbListSheet = workbook.Sheets['全部CB代號'];
                cbListData = XLSX.utils.sheet_to_json(cbListSheet, {header: 1});
                loadInfo.cbCount = cbListData.length - 1;
                console.log('✓ CB清單:', loadInfo.cbCount, '個');
                
                // 讀取月份資料 - 修改為支援5位或6位數字
                excelData = {};
                workbook.SheetNames.forEach(sheetName => {
                    if (/^\d{5,6}$/.test(sheetName)) {  // ← 關鍵修改!支援5位或6位數字
                        const sheet = workbook.Sheets[sheetName];
                        const data = XLSX.utils.sheet_to_json(sheet, {header: 1});
                        excelData[sheetName] = data;
                        loadInfo.months.push(sheetName);
                        console.log('✓ 載入:', sheetName, '(', data.length - 1, '筆)');
                    }
                });
                
                loadInfo.monthCount = loadInfo.months.length;
                loadInfo.months.sort();
                
                console.log('=== 載入完成 ===');
                console.log('總計:', loadInfo.cbCount, '個CB,', loadInfo.monthCount, '個月份');
                
                // 顯示資訊
                const infoBanner = document.getElementById('infoBanner');
                infoBanner.innerHTML = `
                    <strong>✅ 資料載入成功</strong><br>
                    CB清單: ${loadInfo.cbCount} 個 | 
                    月份資料: ${loadInfo.monthCount} 個月 | 
                    範圍: ${convertYM(loadInfo.months[0])} ~ ${convertYM(loadInfo.months[loadInfo.months.length-1])}
                `;
                infoBanner.style.display = 'block';
                document.getElementById('loadingDiv').style.display = 'none';
                
            } catch (error) {
                console.error('載入失敗:', error);
                document.getElementById('loadingDiv').innerHTML = `
                    <div style="color: #dc3545;">
                        載入失敗: ${error.message}<br>
                        <small>請確認 cbas_list.xlsx 與 index.html 在同一位置</small>
                    </div>
                `;
            }
        }
        
        function convertYM(sheetName) {
            // 支援5位數字 (例如: 11409) 或 6位數字 (例如: 202508)
            let year, month;
            if (sheetName.length === 5) {
                // 5位數字: 11409 = 114年09月
                year = parseInt(sheetName.substring(0, 3));
                month = parseInt(sheetName.substring(3, 5));
            } else {
                // 6位數字: 202508 = 2025年08月 = 114年08月
                year = parseInt(sheetName.substring(0, 4)) - 1911;
                month = parseInt(sheetName.substring(4, 6));
            }
            return `${year}/${month.toString().padStart(2, '0')}`;
        }
        
        function searchCB() {
            const cbCode = document.getElementById('cbCodeInput').value.trim();
            if (!cbCode) { alert('請輸入CB代號'); return; }
            if (!excelData) { alert('資料尚未載入'); return; }
            
            console.log('\n=== 搜尋:', cbCode, '===');
            document.getElementById('loadingDiv').style.display = 'block';
            document.getElementById('resultDiv').style.display = 'none';
            
            setTimeout(() => { processSearch(cbCode); }, 300);
        }
        
        function processSearch(cbCode) {
            try {
                // 查找CB名稱
                let cbName = '';
                for (let i = 1; i < cbListData.length; i++) {
                    if (String(cbListData[i][1]).trim() === String(cbCode).trim()) {
                        cbName = cbListData[i][2];
                        console.log('✓ 找到:', cbCode, cbName);
                        break;
                    }
                }
                
                if (!cbName) {
                    console.log('✗ 找不到CB');
                    showError('找不到CB代號: ' + cbCode);
                    return;
                }
                
                // 搜尋月份資料
                const results = [];
                const months = Object.keys(excelData).sort();
                
                months.forEach(month => {
                    const data = excelData[month];
                    for (let i = 1; i < data.length; i++) {
                        if (String(data[i][0]).trim() === String(cbCode).trim()) {
                            const notional = data[i][2] || 0;
                            const shares = Math.floor(notional / 100000);
                            const avg = data[i][6] || 0;
                            const premium = Math.round((avg * notional / 100000 / 10000));
                            
                            results.push({
                                yearMonth: convertYM(month),
                                shares: shares,
                                transactions: data[i][3] || 0,
                                lowest: data[i][4] || 0,
                                highest: data[i][5] || 0,
                                average: avg,
                                term: data[i][7] || 0,
                                premium: premium
                            });
                        }
                    }
                });
                
                console.log('✓ 找到', results.length, '筆資料');
                
                if (results.length === 0) {
                    showError('查無資料: ' + cbCode + ' ' + cbName + '<br><small>此CB在所有月份中都沒有CBAS交易記錄</small>');
                    return;
                }
                
                displayResults(cbCode, cbName, results);
                
            } catch (error) {
                console.error('搜尋錯誤:', error);
                showError('搜尋錯誤: ' + error.message);
            }
        }
        
        function displayResults(cbCode, cbName, results) {
            const monthMap = {};
            results.forEach(r => {
                if (!monthMap[r.yearMonth]) monthMap[r.yearMonth] = [];
                monthMap[r.yearMonth].push(r);
            });
            const hasDup = Object.values(monthMap).some(arr => arr.length > 1);
            
            let html = `
                <div class="result-header">
                    <h2>【查詢結果: ${cbCode} ${cbName}】</h2>
                    <div class="result-info">
                        找到 ${results.length} 筆資料 | 
                        ${Object.keys(monthMap).length} 個月份 | 
                        ${results[0].yearMonth} ~ ${results[results.length-1].yearMonth}
                    </div>
                </div>
                <table>
                    <thead>
                        <tr>
                            <th>年月</th><th>拆解張數</th><th>成交筆數</th>
                            <th>權利金區間(元)</th><th>平均(元)</th><th>期間</th><th>權利金(萬)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            results.forEach(r => {
                const cls = r.term == 2 ? 'term-2' : 'term-3';
                html += `
                    <tr class="${cls}">
                        <td>${r.yearMonth}</td>
                        <td>${r.shares.toLocaleString()}</td>
                        <td>${r.transactions.toLocaleString()}</td>
                        <td>${r.lowest.toFixed(2)} - ${r.highest.toFixed(2)}</td>
                        <td>${r.average.toFixed(2)}</td>
                        <td>${r.term}年</td>
                        <td>${r.premium.toLocaleString()}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            
            if (hasDup) {
                html += '<div class="note-section"><h3>📌 說明:</h3><ul>';
                Object.keys(monthMap).forEach(m => {
                    if (monthMap[m].length > 1) {
                        html += `<li>${m} 出現兩筆資料,分別為新拆解契約與續約契約</li>`;
                    }
                });
                html += '<li>不同契約期間以顏色區分 (淡藍色=2年期，淡紫色=3年期)</li></ul></div>';
            }
            
            document.getElementById('resultDiv').innerHTML = html;
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('resultDiv').style.display = 'block';
        }
        
        function showError(msg) {
            document.getElementById('resultDiv').innerHTML = `
                <div class="error-message">
                    <h3>✗ ${msg}</h3>
                </div>
            `;
            document.getElementById('loadingDiv').style.display = 'none';
            document.getElementById('resultDiv').style.display = 'block';
        }
        
        document.getElementById('cbCodeInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') searchCB();
        });
    </script>
</body>
</html>